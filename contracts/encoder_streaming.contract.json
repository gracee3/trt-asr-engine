{
  "model": "encoder_streaming.onnx",
  "description": "Parakeet TDT 0.6B streaming encoder with cache-aware recurrence",
  "streaming": {
    "layers": 24,
    "cache_size": 256,
    "time_ctx": 4,
    "valid_out_len_expected": 3,
    "cache_drop_size": 3,
    "shift_size": [17, 24],
    "chunk_size": [41, 48],
    "pre_encode_cache_size": [0, 9],
    "drop_extra_pre_encoded": 2
  },
  "inputs": [
    {
      "name": "audio_signal",
      "dtype": "float32",
      "shape": ["B", 128, "T"],
      "description": "Mel-filterbank features",
      "constraints": {
        "T": {
          "typical_values": [41, 48],
          "description": "Feature frames per chunk (typically 41 for first chunk, 48 for subsequent)"
        },
        "B": {
          "typical_values": [1],
          "description": "Batch size (typically 1 for streaming)"
        }
      }
    },
    {
      "name": "length",
      "dtype": "int64",
      "shape": ["B"],
      "description": "Number of valid feature frames in audio_signal"
    },
    {
      "name": "cache_last_channel",
      "dtype": "float32",
      "shape": ["B", 24, 256, 1024],
      "description": "Last-channel cache for 24 Conformer layers (batch-first, fixed max size)",
      "constraints": {
        "layer": 24,
        "cache_dim": 256,
        "hidden_dim": 1024
      }
    },
    {
      "name": "cache_last_time",
      "dtype": "float32",
      "shape": ["B", 24, 1024, 4],
      "description": "Last-time cache for 24 Conformer layers (batch-first, fixed max context)",
      "constraints": {
        "layer": 24,
        "hidden_dim": 1024,
        "context_size": 4
      }
    },
    {
      "name": "cache_last_channel_len",
      "dtype": "int64",
      "shape": ["B"],
      "description": "Number of valid entries in cache_last_channel (0 for first chunk)"
    }
  ],
  "outputs": [
    {
      "name": "encoder_output",
      "dtype": "float32",
      "shape": ["B", 1024, "T_out"],
      "description": "Encoded features for current chunk",
      "constraints": {
        "T_out": {
          "expected": 3,
          "description": "Expected to be 3 when valid_out_len=3 (streaming mode)"
        }
      }
    },
    {
      "name": "encoded_lengths",
      "dtype": "int64",
      "shape": ["B"],
      "description": "Number of valid encoded frames in encoder_output (expected to be 3)"
    },
    {
      "name": "cache_last_channel_out",
      "dtype": "float32",
      "shape": ["B", 24, "C_out", 1024],
      "description": "Updated last-channel cache (batch-first, dynamic C_out <= 256)",
      "constraints": {
        "C_out": {
          "max": 256,
          "description": "Dynamic cache size, needs padding to 256 for next iteration"
        }
      }
    },
    {
      "name": "cache_last_time_out",
      "dtype": "float32",
      "shape": ["B", 24, 1024, "K_out"],
      "description": "Updated last-time cache (batch-first, dynamic K_out <= 4)",
      "constraints": {
        "K_out": {
          "max": 4,
          "description": "Dynamic context size, needs padding to 4 for next iteration"
        }
      }
    },
    {
      "name": "cache_last_channel_len_out",
      "dtype": "int64",
      "shape": ["B"],
      "description": "Updated number of valid entries in cache_last_channel_out"
    }
  ],
  "trt_optimization_profiles": [
    {
      "name": "streaming_profile_41",
      "description": "Optimized for first chunk (T=41)",
      "dimensions": {
        "audio_signal.T": {"min": 41, "opt": 41, "max": 41},
        "B": {"min": 1, "opt": 1, "max": 1}
      }
    },
    {
      "name": "streaming_profile_48",
      "description": "Optimized for subsequent chunks (T=48)",
      "dimensions": {
        "audio_signal.T": {"min": 48, "opt": 48, "max": 48},
        "B": {"min": 1, "opt": 1, "max": 1}
      }
    },
    {
      "name": "unified_profile",
      "description": "Unified profile supporting both chunk sizes",
      "dimensions": {
        "audio_signal.T": {"min": 41, "opt": 48, "max": 48},
        "B": {"min": 1, "opt": 1, "max": 8}
      }
    }
  ],
  "runtime_contract": {
    "cache_padding": {
      "description": "Cache outputs are dynamic but must be padded to fixed max sizes for next iteration",
      "cache_last_channel_out": {
        "axis": 2,
        "pad_to": 256,
        "side": "right",
        "fill_value": 0.0
      },
      "cache_last_time_out": {
        "axis": 3,
        "pad_to": 4,
        "side": "right",
        "fill_value": 0.0
      }
    },
    "initialization": {
      "cache_last_channel": "zeros [B, 24, 256, 1024]",
      "cache_last_time": "zeros [B, 24, 1024, 4]",
      "cache_last_channel_len": "zeros [B]"
    },
    "assertions": {
      "encoder_output_time_dim": "Should equal 3 when valid_out_len=3",
      "encoded_lengths": "Should equal 3 for streaming chunks",
      "cache_last_channel_len_out": "Should be >= 0 and non-decreasing until cache_size"
    }
  },
  "validation": {
    "parity_test": "tools/onnxruntime/onnx_streaming_parity.py",
    "reference_jsonl": "artifacts/reference/pytorch_reference_50.jsonl",
    "tolerance": {
      "atol": 1e-4,
      "rtol": 1e-4
    },
    "test_modes": ["functional", "closed_loop"]
  }
}
